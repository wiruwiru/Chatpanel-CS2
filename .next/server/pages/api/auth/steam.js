"use strict";(()=>{var e={};e.id=672,e.ids=[672],e.modules={3480:(e,t,a)=>{e.exports=a(5600)},3746:(e,t,a)=>{a.r(t),a.d(t,{config:()=>d,default:()=>l,routeModule:()=>_});var n={};a.r(n),a.d(n,{default:()=>c});var r=a(3480),i=a(8667),o=a(6435),E=a(8278),s=a.n(E);let u=require("passport-steam");var T=a(8954);async function A(e,t,a){try{await e.execute(a)}catch(e){if("ER_TABLE_EXISTS_ERROR"!==e.code)throw e}}function c(e,t){"GET"===e.method?s().authenticate("steam")(e,t,()=>{}):t.status(405).json({message:"Method not allowed"})}s().use(new u.Strategy({returnURL:`${process.env.BASE_URL}/api/auth/steam/return`,realm:process.env.BASE_URL,apiKey:process.env.STEAM_API_KEY},async function(e,t,a){let n=t.id;try{let e=await T.A.getConnection();await A(e,"chatpanel_authorized",`
        CREATE TABLE IF NOT EXISTS chatpanel_authorized (
          id INT AUTO_INCREMENT PRIMARY KEY,
          steam_id VARCHAR(255) UNIQUE NOT NULL,
          role ENUM('admin', 'user') NOT NULL DEFAULT 'user',
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
      `),await A(e,"chatpanel_users",`
        CREATE TABLE IF NOT EXISTS chatpanel_users (
          id INT AUTO_INCREMENT PRIMARY KEY,
          steam_id VARCHAR(255) UNIQUE NOT NULL,
          last_login TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
      `);let[r]=await e.execute("SELECT COUNT(*) as count FROM chatpanel_authorized");if(0===r[0].count)await e.execute("INSERT INTO chatpanel_authorized (steam_id, role) VALUES (?, ?)",[n,"admin"]);else{let[t]=await e.execute("SELECT * FROM chatpanel_authorized WHERE steam_id = ?",[n]);if(0===t.length)return e.release(),a(null,!1,{message:"User not authorized"})}let[i]=await e.execute("SELECT role FROM chatpanel_authorized WHERE steam_id = ?",[n]),o=i[0]?i[0].role:"user";return await e.execute("INSERT INTO chatpanel_users (steam_id, last_login) VALUES (?, CURRENT_TIMESTAMP) ON DUPLICATE KEY UPDATE last_login = CURRENT_TIMESTAMP",[n]),e.release(),a(null,{...t,steamId64:n,role:o})}catch(e){return console.error("Error during authentication:",e),a(e)}}));let l=(0,o.M)(n,"default"),d=(0,o.M)(n,"config"),_=new r.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/auth/steam",pathname:"/api/auth/steam",bundlePath:"",filename:""},userland:n})},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},8278:e=>{e.exports=require("passport")},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return a}});var a=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},8954:(e,t,a)=>{a.d(t,{A:()=>r});let n=require("mysql2/promise"),r=a.n(n)().createPool({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,waitForConnections:!0,connectionLimit:10,queueLimit:0})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=3746);module.exports=a})();